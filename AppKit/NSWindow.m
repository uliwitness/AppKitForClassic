#import "NSWindow.h"#import "NSEvent.h"#import "NSView.h"#import "NSColor.h"#import "NSGraphicsContext.h"#import <MacWindows.h>#import <stdio.h>@implementation NSWindow-(id) initWithFrame: (NSRect)box title: (NSString*)title{	Rect qdBox = QDRectFromNSRect(box);	self = [super init];	if( self ) {		_title = [title retain];		newcwindow(&_macWindow, &qdBox,                                 [_title cString],                                 false, /*invisible*/                                 zoomDocProc,                                 (WindowPtr) -1, /*frontmost*/                                 true, /*closeBox*/                                 (long)self);        _contentView = [[NSWindowContentView alloc] initWithFrame: box];        [_contentView setBackgroundColor: [NSColor lightGrayColor]];        [_contentView setWindow: self];        _hasWindow = YES;	}		return self;}-(void) dealloc{	if(_hasWindow) {		CloseWindow( (GrafPtr)&_macWindow );		_hasWindow = NO;	}	[_title release];	[_contentView release];	[super dealloc];}-(NSColor*) backgroundColor{	return [_contentView backgroundColor];}-(void) setBackgroundColor: (NSColor*)c{	[_contentView setBackgroundColor: c];}-(void) draw{	NSGraphicsContext *newCtx;	Rect growRect;	NSRect windowContents;	RgnHandle oldClip;		if(!_hasWindow) {		return;	}	newCtx = [[NSGraphicsContext alloc] initWithGraphicsPort: (GrafPtr)&_macWindow];	growRect = _macWindow.port.portRect;	windowContents = NSRectFromQDRect(_macWindow.port.portRect);	oldClip = NewRgn();	growRect.left = growRect.right - 15;	growRect.top = growRect.bottom - 15;	windowContents.origin.x = 0;	windowContents.origin.y = 0;	[NSGraphicsContext saveGraphicsState];	[NSGraphicsContext setCurrentContext: newCtx];		[_contentView _drawRect: windowContents withOffset: NSMakePoint(0, 0)];		GetClip( oldClip );	ClipRect( &growRect );	DrawGrowIcon( (GrafPtr)&_macWindow );	SetClip( oldClip );		[NSGraphicsContext restoreGraphicsState];	[newCtx release];}-(void) activate{	if(!_hasWindow) {		return;	}	HiliteWindow((GrafPtr)&_macWindow, true);}-(void) deactivate{	if(!_hasWindow) {		return;	}	HiliteWindow((GrafPtr)&_macWindow, false);}-(NSPoint) convertPoint: (NSPoint)pos fromWindow: (NSWindow*)otherWin{	Point localPos = QDPointFromNSPoint(pos);	if( otherWin == nil && _hasWindow ) {		GrafPtr oldPort = NULL;		GetPort( &oldPort );		SetPort((GrafPtr)&_macWindow);				GlobalToLocal( &localPos );				SetPort( oldPort );	}	// TODO: Implement case of otherWin != nil		return NSPointFromQDPoint(localPos);}-(void) makeKeyAndOrderFront: (id)sender{	if(!_hasWindow) {		return;	}	ShowWindow( (GrafPtr)&_macWindow );	SelectWindow( (GrafPtr)&_macWindow );}-(void) setSize: (NSSize)newSize{	GrafPtr oldPort;	NSRect oldRect;	NSRect newRect;	if(!_hasWindow) {		return;	}	oldRect = NSRectFromQDRect(_macWindow.port.portRect);	newRect = oldRect;	SizeWindow( (GrafPtr)&_macWindow, newSize.width, newSize.height, false);	GetPort( &oldPort );	SetPort( (GrafPtr)&_macWindow );	InvalRect( &_macWindow.port.portRect );	SetPort( oldPort );		newRect.size = newSize;	[_contentView setFrame: newRect];	[_contentView resizeSubviewsWithOldSize: oldRect.size];}-(void) mouseDown: (NSEvent*)event{	if(!_hasWindow) {		return;	}	[self makeKeyAndOrderFront: self];		[_contentView _mouseDown: event];}-(void) mouseUp: (NSEvent*)event{	if(!_hasWindow) {		return;	}	//printf("Mouse released at %f,%f\n", [event locationInWindow].x, [event locationInWindow].y);}-(void) performClose: (id)sender{	if(!_hasWindow) {		return;	}		CloseWindow( (GrafPtr)&_macWindow );	_hasWindow = NO;}-(NSView*) contentView{	return _contentView;}-(NSResponder*) firstResponder{	return _firstResponder;}-(BOOL) makeFirstResponder: (NSResponder*)responder{	if (_firstResponder == responder) {		return YES; // Nothing to do, you got what you want.	}	if (_firstResponder && ![_firstResponder resignFirstResponder] ) {		return NO;	}	if (responder && ![responder acceptsFirstResponder] ) {		return NO;	}	if (responder && ![responder becomeFirstResponder]) {		return NO;	}	_firstResponder = responder;	return YES;}-(GrafPtr) macGraphicsPort{	if(!_hasWindow) {		return NULL;	}			return (GrafPtr) &_macWindow;}-(void) orderFrontStandardAboutPanel: (id)sender{	printf("Window About panel! WHOOO!\r");}+(NSWindow*)windowFromMacWindow: (WindowPtr)window{	return (NSWindow*) GetWRefCon(window);}@end